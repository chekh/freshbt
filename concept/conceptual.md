### Описание проекта

Проект представляет собой бэктестер для торговых стратегий, который моделирует работу брокера и взаимодействует с торговой стратегией. Бэктестер позволяет проводить симуляции торговых операций на исторических данных, поддерживает работу с различными типами ордеров, включая OCO (One Cancels the Other) ордера, и обеспечивает учет маржинальной торговли с кредитным плечом. В результате работы бэктестера рассчитываются и выводятся различные метрики, такие как profit factor и sharpe ratio, а также ведется подробная статистика торговых операций.

### Основные компоненты проекта

1. **Backtester**: Основной класс, управляющий процессом бэктестирования. Включает в себя логику обработки исторических данных, исполнения ордеров и обновления стратегий.
2. **DataHandler**: Класс, ответственный за загрузку и предоставление исторических данных для бэктестера.
3. **Broker**: Класс, моделирующий работу брокера. Включает поддержку различных типов ордеров (рыночные, лимитные, стоп, OCO), учет маржинальной торговли и кредитного плеча.
4. **Strategy**: Базовый класс для реализации торговых стратегий. Стратегия обновляется на каждом шаге симуляции и генерирует новые ордера для исполнения.
5. **Logger**: Класс для ведения логов и записи результатов бэктестирования.
6. **Statistics**: Класс для ведения статистики торговых операций.
7. **Metrics**: Класс для расчета метрик эффективности торговых стратегий.

### Требования к разработке

1. **Язык программирования**: Python 3.7 и выше.
2. **Библиотеки и зависимости**:
   - pandas: для работы с историческими данными.
   - numpy: для численных вычислений.
   - matplotlib: для визуализации результатов (опционально).
   - numba (опционально): для ускорения вычислений.
3. **Архитектура и дизайн**:
   - Использование интерфейсов и абстрактных классов для обеспечения модульности и расширяемости (например, `IDataHandler`, `IBroker`, `IStrategy`).
   - Четкое разделение ответственности между компонентами (DataHandler, Broker, Strategy и т.д.).
   - Возможность легкой замены и модификации компонентов (например, замена стратегии или брокера).
4. **Функциональные требования**:
   - Поддержка различных типов ордеров: рыночные, лимитные, стоп, OCO.
   - Учет маржинальной торговли и кредитного плеча.
   - Проверка условий исполнения ордеров (например, стоп-лосс, тейк-профит).
   - Ведение подробной статистики торговых операций.
   - Расчет и вывод метрик эффективности (profit factor, sharpe ratio и т.д.).
   - Ведение логов и запись результатов бэктестирования.
5. **Платформа**: Проект должен быть кросс-платформенным и работать на Windows, macOS и Linux.
6. **Документация**:
   - Подробная документация по каждому компоненту проекта.
   - Примеры использования и руководство пользователя.
7. **Тестирование**:
   - Разработка и проведение модульных тестов для основных компонентов проекта.
   - Тестирование на различных наборах исторических данных.


### Требования к разработке бэктестера с управлением состоянием счета и маржин-коллом

#### Общие требования

1. **Язык разработки**: Python.
2. **Среда разработки**: Jupyter Notebook, PyCharm или любая другая подходящая IDE.
3. **Библиотеки**: pandas для работы с данными, numpy для математических операций.

#### Основные компоненты

1. **Класс TradingAccount**: Управляет состоянием счета трейдера, выполняет расчеты маржи и эквити.
2. **Класс Broker**: Исполняет ордера, мониторит маржинальные требования и управляет маржин-коллом.

### Требования к классу TradingAccount

1. **Инициализация счета**
   - **Параметры**: начальный баланс, маржинальные требования, кредитное плечо (если применяется), порог маржин-колла.
   - **Описание**: Необходимо создать метод инициализации счета с заданными параметрами.

2. **Расчет маржи**
   - **Формула**: 
     \[
     \text{Margin} = \frac{\text{Position Size}}{\text{Leverage}}
     \]
     или
     \[
     \text{Margin} = \text{Position Size} \times \text{Margin Requirement}
     \]
   - **Описание**: Метод должен рассчитывать необходимую маржу для открытия позиции на основе объема и цены.

3. **Обновление эквити**
   - **Формула**: 
     \[
     \text{Equity} = \text{Balance} + \text{Unrealized P/L}
     \]
   - **Описание**: Метод должен обновлять текущую стоимость счета с учетом нереализованной прибыли или убытка.

4. **Расчет свободной маржи**
   - **Формула**: 
     \[
     \text{Free Margin} = \text{Equity} - \text{Margin}
     \]
   - **Описание**: Метод должен рассчитывать средства, доступные для открытия новых позиций.

5. **Расчет уровня маржи**
   - **Формула**: 
     \[
     \text{Margin Level} = \frac{\text{Equity}}{\text{Margin}} \times 100\%
     \]
   - **Описание**: Метод должен рассчитывать отношение эквити к использованной марже.

### Требования к классу Broker

1. **Инициализация брокера**
   - **Параметры**: список счетов трейдеров, рыночные данные (цены активов).
   - **Описание**: Метод инициализации должен создавать брокера с заданными параметрами.

2. **Исполнение ордеров**
   - **Описание**: Метод должен исполнять ордера на покупку и продажу, переданные от счетов трейдеров, обновлять рыночные данные и пересчитывать маржу.

3. **Мониторинг маржинальных требований**
   - **Описание**: Метод должен проверять уровень маржи для каждого счета трейдера после каждой операции.

4. **Обработка маржин-колла**
   - **Описание**: Метод должен уведомлять трейдера о необходимости пополнения счета или закрытия позиций, а также принудительно закрывать позиции в случае недостаточности средств для поддержания уровня маржи.

5. **Обновление рыночных данных**
   - **Описание**: Метод должен получать и обновлять текущие цены активов.

6. **Поддержка множества счетов**
   - **Описание**: Метод должен управлять несколькими счетами трейдеров и их состояниями.

### Логика управления терминальными состояниями

1. **Баланс (Balance)**
   - **Описание**: Содержит начальный депозит и обновляется при закрытии позиций с учетом реализованных прибылей или убытков.

2. **Эквити (Equity)**
   - **Описание**: Рассчитывается как сумма баланса и нереализованной прибыли или убытка, обновляется в реальном времени с учетом изменений цен на открытые позиции.

3. **Маржа (Margin)**
   - **Описание**: Расчет маржи для каждой открытой позиции на основе объема позиции, цены и маржинальных требований, суммируется для всех открытых позиций.

4. **Свободная маржа (Free Margin)**
   - **Описание**: Рассчитывается как разница между эквити и общей маржей.

5. **Уровень маржи (Margin Level)**
   - **Описание**: Рассчитывается как отношение эквити к общей марже, выраженное в процентах, и используется для определения необходимости маржин-колла.

### Логика маржин-колла

1. **Порог маржин-колла**
   - **Описание**: Устанавливается как процент от уровня маржи (например, 100% для форекс или 30% для фондового рынка).

2. **Проверка маржин-колла**
   - **Описание**: Метод должен проверять уровень маржи и вызывать метод обработки маржин-колла при необходимости.

3. **Обработка маржин-колла**
   - **Описание**: Метод должен закрывать позиции в порядке убывания риска до тех пор, пока уровень маржи не восстановится выше порога.